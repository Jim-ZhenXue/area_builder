// Copyright 2017-2024, University of Colorado Boulder
/**
 * Combines all parts of a runnable's built file into one HTML file.
 *
 * @author Jonathan Olson <jonathan.olson@colorado.edu>
 */ // modules
import assert from 'assert';
import fs from 'fs';
import grunt from '../../../perennial-alias/js/npm-dependencies/grunt.js';
import ChipperStringUtils from '../common/ChipperStringUtils.js';
import getTitleStringKey from './getTitleStringKey.js';
const pako = require('pako');
const nodeHtmlEncoder = require('node-html-encoder');
/**
 * From a given set of config (including the JS and other required things), it creates an HTML file for a runnable.
 */ export default function packageRunnable(config) {
    const encoder = new nodeHtmlEncoder.Encoder('entity');
    const { repo, stringMap, licenseScript, scripts, locale, htmlHeader, compressScripts = false } = config;
    assert(stringMap, 'Requires stringMap');
    assert(scripts, 'Requires scripts');
    assert(licenseScript, 'Requires license script');
    const localizedTitle = stringMap[locale][getTitleStringKey(repo)];
    // Directory on the PhET website where the latest version of the sim lives
    const latestDir = `https://phet.colorado.edu/sims/html/${repo}/latest/`;
    // Converts a Uint8Array to a base64-encoded string (the usual String.fromCharCode.apply trick doesn't work for large arrays)
    const encodeBytes = (uint8Array)=>{
        let binary = '';
        const len = uint8Array.byteLength;
        for(let i = 0; i < len; i++){
            binary += String.fromCharCode(uint8Array[i]);
        }
        return btoa(binary);
    };
    // Converts from a JS string to a base64-encoded string
    const toEncodedString = (string)=>encodeBytes(pako.deflate(string));
    // Converts from a JS string to a compressed JS string that can be run
    const toRunString = (string)=>`_C('${toEncodedString(string)}')`;
    let scriptSection;
    if (compressScripts) {
        scriptSection = `<script>\n${licenseScript}\n</script>` + `<script>${fs.readFileSync('../sherpa/lib/pako_inflate-2.0.3.min.js', 'utf-8')}</script>\n` + '<script>let _R=q=>{var s=document.createElement("script");s.type=\'text/javascript\';s.async=false;var c=document.createTextNode(q);s.appendChild(c);document.body.appendChild(s);};let _D=s=>{const ar=new Uint8Array(s.length);for (let i=0;i<s.length;i++){ar[i]=s.charCodeAt(i);}return ar;};let _F=s=>pako.inflate(_D(atob(s)),{to:\'string\'});let _C=string=>_R(_F(string));' + scripts.map((script)=>`${toRunString(script)}`).join('\n') + '</script>';
    } else {
        scriptSection = [
            licenseScript,
            ...scripts
        ].map((script)=>`<script type="text/javascript">${script}</script>`).join('\n');
    }
    return ChipperStringUtils.replacePlaceholders(grunt.file.read('../chipper/templates/sim.html'), {
        PHET_CARRIAGE_RETURN: '\r',
        PHET_SIM_TITLE: encoder.htmlEncode(localizedTitle),
        PHET_HTML_HEADER: htmlHeader,
        // wrap scripts in global check for IE
        PHET_SIM_SCRIPTS: scriptSection,
        // metadata for Open Graph protocol, see phet-edmodo#2
        OG_TITLE: encoder.htmlEncode(localizedTitle),
        OG_URL: `${latestDir}${repo}_${locale}.html`,
        OG_IMAGE: `${latestDir}${repo}-600.png`
    });
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL2pzL2dydW50L3BhY2thZ2VSdW5uYWJsZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvLyBDb3B5cmlnaHQgMjAxNy0yMDI0LCBVbml2ZXJzaXR5IG9mIENvbG9yYWRvIEJvdWxkZXJcblxuLyoqXG4gKiBDb21iaW5lcyBhbGwgcGFydHMgb2YgYSBydW5uYWJsZSdzIGJ1aWx0IGZpbGUgaW50byBvbmUgSFRNTCBmaWxlLlxuICpcbiAqIEBhdXRob3IgSm9uYXRoYW4gT2xzb24gPGpvbmF0aGFuLm9sc29uQGNvbG9yYWRvLmVkdT5cbiAqL1xuXG4vLyBtb2R1bGVzXG5pbXBvcnQgYXNzZXJ0IGZyb20gJ2Fzc2VydCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuaW1wb3J0IGdydW50IGZyb20gJy4uLy4uLy4uL3BlcmVubmlhbC1hbGlhcy9qcy9ucG0tZGVwZW5kZW5jaWVzL2dydW50LmpzJztcbmltcG9ydCBDaGlwcGVyU3RyaW5nVXRpbHMgZnJvbSAnLi4vY29tbW9uL0NoaXBwZXJTdHJpbmdVdGlscy5qcyc7XG5pbXBvcnQgeyBTdHJpbmdNYXAgfSBmcm9tICcuL2dldFN0cmluZ01hcC5qcyc7XG5pbXBvcnQgZ2V0VGl0bGVTdHJpbmdLZXkgZnJvbSAnLi9nZXRUaXRsZVN0cmluZ0tleS5qcyc7XG5cbmNvbnN0IHBha28gPSByZXF1aXJlKCAncGFrbycgKTtcbmNvbnN0IG5vZGVIdG1sRW5jb2RlciA9IHJlcXVpcmUoICdub2RlLWh0bWwtZW5jb2RlcicgKTtcblxudHlwZSBQYWNrYWdlUnVubmFibGVPcHRpb25zID0ge1xuICByZXBvOiBzdHJpbmc7XG4gIHN0cmluZ01hcDogU3RyaW5nTWFwO1xuICBsaWNlbnNlU2NyaXB0OiBzdHJpbmc7XG4gIHNjcmlwdHM6IHN0cmluZ1tdO1xuICBsb2NhbGU6IHN0cmluZztcbiAgaHRtbEhlYWRlcjogc3RyaW5nO1xuICBjb21wcmVzc1NjcmlwdHM/OiBib29sZWFuO1xufTtcblxuLyoqXG4gKiBGcm9tIGEgZ2l2ZW4gc2V0IG9mIGNvbmZpZyAoaW5jbHVkaW5nIHRoZSBKUyBhbmQgb3RoZXIgcmVxdWlyZWQgdGhpbmdzKSwgaXQgY3JlYXRlcyBhbiBIVE1MIGZpbGUgZm9yIGEgcnVubmFibGUuXG4gKi9cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIHBhY2thZ2VSdW5uYWJsZSggY29uZmlnOiBQYWNrYWdlUnVubmFibGVPcHRpb25zICk6IHN0cmluZyB7XG5cbiAgY29uc3QgZW5jb2RlciA9IG5ldyBub2RlSHRtbEVuY29kZXIuRW5jb2RlciggJ2VudGl0eScgKTtcblxuICBjb25zdCB7XG4gICAgcmVwbywgLy8ge3N0cmluZ31cbiAgICBzdHJpbmdNYXAsIC8vIHtPYmplY3R9LCBtYXBbIGxvY2FsZSBdWyBzdHJpbmdLZXkgXSA9PiB7c3RyaW5nfVxuICAgIGxpY2Vuc2VTY3JpcHQsIC8vIHtzdHJpbmd9XG4gICAgc2NyaXB0cywgLy8ge0FycmF5LjxzdHJpbmc+fVxuICAgIGxvY2FsZSwgLy8ge3N0cmluZ31cbiAgICBodG1sSGVhZGVyLCAvLyB7c3RyaW5nfVxuICAgIGNvbXByZXNzU2NyaXB0cyA9IGZhbHNlXG4gIH0gPSBjb25maWc7XG4gIGFzc2VydCggc3RyaW5nTWFwLCAnUmVxdWlyZXMgc3RyaW5nTWFwJyApO1xuICBhc3NlcnQoIHNjcmlwdHMsICdSZXF1aXJlcyBzY3JpcHRzJyApO1xuICBhc3NlcnQoIGxpY2Vuc2VTY3JpcHQsICdSZXF1aXJlcyBsaWNlbnNlIHNjcmlwdCcgKTtcblxuICBjb25zdCBsb2NhbGl6ZWRUaXRsZSA9IHN0cmluZ01hcFsgbG9jYWxlIF1bIGdldFRpdGxlU3RyaW5nS2V5KCByZXBvICkgXTtcblxuICAvLyBEaXJlY3Rvcnkgb24gdGhlIFBoRVQgd2Vic2l0ZSB3aGVyZSB0aGUgbGF0ZXN0IHZlcnNpb24gb2YgdGhlIHNpbSBsaXZlc1xuICBjb25zdCBsYXRlc3REaXIgPSBgaHR0cHM6Ly9waGV0LmNvbG9yYWRvLmVkdS9zaW1zL2h0bWwvJHtyZXBvfS9sYXRlc3QvYDtcblxuICAvLyBDb252ZXJ0cyBhIFVpbnQ4QXJyYXkgdG8gYSBiYXNlNjQtZW5jb2RlZCBzdHJpbmcgKHRoZSB1c3VhbCBTdHJpbmcuZnJvbUNoYXJDb2RlLmFwcGx5IHRyaWNrIGRvZXNuJ3Qgd29yayBmb3IgbGFyZ2UgYXJyYXlzKVxuICBjb25zdCBlbmNvZGVCeXRlcyA9ICggdWludDhBcnJheTogVWludDhBcnJheSApID0+IHtcbiAgICBsZXQgYmluYXJ5ID0gJyc7XG4gICAgY29uc3QgbGVuID0gdWludDhBcnJheS5ieXRlTGVuZ3RoO1xuICAgIGZvciAoIGxldCBpID0gMDsgaSA8IGxlbjsgaSsrICkge1xuICAgICAgYmluYXJ5ICs9IFN0cmluZy5mcm9tQ2hhckNvZGUoIHVpbnQ4QXJyYXlbIGkgXSApO1xuICAgIH1cbiAgICByZXR1cm4gYnRvYSggYmluYXJ5ICk7XG4gIH07XG5cbiAgLy8gQ29udmVydHMgZnJvbSBhIEpTIHN0cmluZyB0byBhIGJhc2U2NC1lbmNvZGVkIHN0cmluZ1xuICBjb25zdCB0b0VuY29kZWRTdHJpbmcgPSAoIHN0cmluZzogc3RyaW5nICkgPT4gZW5jb2RlQnl0ZXMoIHBha28uZGVmbGF0ZSggc3RyaW5nICkgKTtcblxuICAvLyBDb252ZXJ0cyBmcm9tIGEgSlMgc3RyaW5nIHRvIGEgY29tcHJlc3NlZCBKUyBzdHJpbmcgdGhhdCBjYW4gYmUgcnVuXG4gIGNvbnN0IHRvUnVuU3RyaW5nID0gKCBzdHJpbmc6IHN0cmluZyApID0+IGBfQygnJHt0b0VuY29kZWRTdHJpbmcoIHN0cmluZyApfScpYDtcblxuICBsZXQgc2NyaXB0U2VjdGlvbjtcbiAgaWYgKCBjb21wcmVzc1NjcmlwdHMgKSB7XG4gICAgc2NyaXB0U2VjdGlvbiA9IGA8c2NyaXB0PlxcbiR7bGljZW5zZVNjcmlwdH1cXG48L3NjcmlwdD5gICtcbiAgICAgICAgICAgICAgICAgICAgYDxzY3JpcHQ+JHtmcy5yZWFkRmlsZVN5bmMoICcuLi9zaGVycGEvbGliL3Bha29faW5mbGF0ZS0yLjAuMy5taW4uanMnLCAndXRmLTgnICl9PC9zY3JpcHQ+XFxuYCArXG4gICAgICAgICAgICAgICAgICAgICc8c2NyaXB0PmxldCBfUj1xPT57dmFyIHM9ZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcInNjcmlwdFwiKTtzLnR5cGU9XFwndGV4dC9qYXZhc2NyaXB0XFwnO3MuYXN5bmM9ZmFsc2U7dmFyIGM9ZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocSk7cy5hcHBlbmRDaGlsZChjKTtkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKHMpO307bGV0IF9EPXM9Pntjb25zdCBhcj1uZXcgVWludDhBcnJheShzLmxlbmd0aCk7Zm9yIChsZXQgaT0wO2k8cy5sZW5ndGg7aSsrKXthcltpXT1zLmNoYXJDb2RlQXQoaSk7fXJldHVybiBhcjt9O2xldCBfRj1zPT5wYWtvLmluZmxhdGUoX0QoYXRvYihzKSkse3RvOlxcJ3N0cmluZ1xcJ30pO2xldCBfQz1zdHJpbmc9Pl9SKF9GKHN0cmluZykpOycgK1xuICAgICAgICAgICAgICAgICAgICBzY3JpcHRzLm1hcCggc2NyaXB0ID0+IGAke3RvUnVuU3RyaW5nKCBzY3JpcHQgKX1gICkuam9pbiggJ1xcbicgKSArICc8L3NjcmlwdD4nO1xuICB9XG4gIGVsc2Uge1xuICAgIHNjcmlwdFNlY3Rpb24gPSBbIGxpY2Vuc2VTY3JpcHQsIC4uLnNjcmlwdHMgXS5tYXAoIHNjcmlwdCA9PiBgPHNjcmlwdCB0eXBlPVwidGV4dC9qYXZhc2NyaXB0XCI+JHtzY3JpcHR9PC9zY3JpcHQ+YCApLmpvaW4oICdcXG4nICk7XG4gIH1cblxuICByZXR1cm4gQ2hpcHBlclN0cmluZ1V0aWxzLnJlcGxhY2VQbGFjZWhvbGRlcnMoIGdydW50LmZpbGUucmVhZCggJy4uL2NoaXBwZXIvdGVtcGxhdGVzL3NpbS5odG1sJyApLCB7XG4gICAgUEhFVF9DQVJSSUFHRV9SRVRVUk46ICdcXHInLFxuICAgIFBIRVRfU0lNX1RJVExFOiBlbmNvZGVyLmh0bWxFbmNvZGUoIGxvY2FsaXplZFRpdGxlICksXG4gICAgUEhFVF9IVE1MX0hFQURFUjogaHRtbEhlYWRlcixcblxuICAgIC8vIHdyYXAgc2NyaXB0cyBpbiBnbG9iYWwgY2hlY2sgZm9yIElFXG4gICAgUEhFVF9TSU1fU0NSSVBUUzogc2NyaXB0U2VjdGlvbixcblxuICAgIC8vIG1ldGFkYXRhIGZvciBPcGVuIEdyYXBoIHByb3RvY29sLCBzZWUgcGhldC1lZG1vZG8jMlxuICAgIE9HX1RJVExFOiBlbmNvZGVyLmh0bWxFbmNvZGUoIGxvY2FsaXplZFRpdGxlICksXG4gICAgT0dfVVJMOiBgJHtsYXRlc3REaXJ9JHtyZXBvfV8ke2xvY2FsZX0uaHRtbGAsXG4gICAgT0dfSU1BR0U6IGAke2xhdGVzdERpcn0ke3JlcG99LTYwMC5wbmdgXG4gIH0gKTtcbn0iXSwibmFtZXMiOlsiYXNzZXJ0IiwiZnMiLCJncnVudCIsIkNoaXBwZXJTdHJpbmdVdGlscyIsImdldFRpdGxlU3RyaW5nS2V5IiwicGFrbyIsInJlcXVpcmUiLCJub2RlSHRtbEVuY29kZXIiLCJwYWNrYWdlUnVubmFibGUiLCJjb25maWciLCJlbmNvZGVyIiwiRW5jb2RlciIsInJlcG8iLCJzdHJpbmdNYXAiLCJsaWNlbnNlU2NyaXB0Iiwic2NyaXB0cyIsImxvY2FsZSIsImh0bWxIZWFkZXIiLCJjb21wcmVzc1NjcmlwdHMiLCJsb2NhbGl6ZWRUaXRsZSIsImxhdGVzdERpciIsImVuY29kZUJ5dGVzIiwidWludDhBcnJheSIsImJpbmFyeSIsImxlbiIsImJ5dGVMZW5ndGgiLCJpIiwiU3RyaW5nIiwiZnJvbUNoYXJDb2RlIiwiYnRvYSIsInRvRW5jb2RlZFN0cmluZyIsInN0cmluZyIsImRlZmxhdGUiLCJ0b1J1blN0cmluZyIsInNjcmlwdFNlY3Rpb24iLCJyZWFkRmlsZVN5bmMiLCJtYXAiLCJzY3JpcHQiLCJqb2luIiwicmVwbGFjZVBsYWNlaG9sZGVycyIsImZpbGUiLCJyZWFkIiwiUEhFVF9DQVJSSUFHRV9SRVRVUk4iLCJQSEVUX1NJTV9USVRMRSIsImh0bWxFbmNvZGUiLCJQSEVUX0hUTUxfSEVBREVSIiwiUEhFVF9TSU1fU0NSSVBUUyIsIk9HX1RJVExFIiwiT0dfVVJMIiwiT0dfSU1BR0UiXSwibWFwcGluZ3MiOiJBQUFBLHNEQUFzRDtBQUV0RDs7OztDQUlDLEdBRUQsVUFBVTtBQUNWLE9BQU9BLFlBQVksU0FBUztBQUM1QixPQUFPQyxRQUFRLEtBQUs7QUFDcEIsT0FBT0MsV0FBVyx3REFBd0Q7QUFDMUUsT0FBT0Msd0JBQXdCLGtDQUFrQztBQUVqRSxPQUFPQyx1QkFBdUIseUJBQXlCO0FBRXZELE1BQU1DLE9BQU9DLFFBQVM7QUFDdEIsTUFBTUMsa0JBQWtCRCxRQUFTO0FBWWpDOztDQUVDLEdBQ0QsZUFBZSxTQUFTRSxnQkFBaUJDLE1BQThCO0lBRXJFLE1BQU1DLFVBQVUsSUFBSUgsZ0JBQWdCSSxPQUFPLENBQUU7SUFFN0MsTUFBTSxFQUNKQyxJQUFJLEVBQ0pDLFNBQVMsRUFDVEMsYUFBYSxFQUNiQyxPQUFPLEVBQ1BDLE1BQU0sRUFDTkMsVUFBVSxFQUNWQyxrQkFBa0IsS0FBSyxFQUN4QixHQUFHVDtJQUNKVCxPQUFRYSxXQUFXO0lBQ25CYixPQUFRZSxTQUFTO0lBQ2pCZixPQUFRYyxlQUFlO0lBRXZCLE1BQU1LLGlCQUFpQk4sU0FBUyxDQUFFRyxPQUFRLENBQUVaLGtCQUFtQlEsTUFBUTtJQUV2RSwwRUFBMEU7SUFDMUUsTUFBTVEsWUFBWSxDQUFDLG9DQUFvQyxFQUFFUixLQUFLLFFBQVEsQ0FBQztJQUV2RSw2SEFBNkg7SUFDN0gsTUFBTVMsY0FBYyxDQUFFQztRQUNwQixJQUFJQyxTQUFTO1FBQ2IsTUFBTUMsTUFBTUYsV0FBV0csVUFBVTtRQUNqQyxJQUFNLElBQUlDLElBQUksR0FBR0EsSUFBSUYsS0FBS0UsSUFBTTtZQUM5QkgsVUFBVUksT0FBT0MsWUFBWSxDQUFFTixVQUFVLENBQUVJLEVBQUc7UUFDaEQ7UUFDQSxPQUFPRyxLQUFNTjtJQUNmO0lBRUEsdURBQXVEO0lBQ3ZELE1BQU1PLGtCQUFrQixDQUFFQyxTQUFvQlYsWUFBYWhCLEtBQUsyQixPQUFPLENBQUVEO0lBRXpFLHNFQUFzRTtJQUN0RSxNQUFNRSxjQUFjLENBQUVGLFNBQW9CLENBQUMsSUFBSSxFQUFFRCxnQkFBaUJDLFFBQVMsRUFBRSxDQUFDO0lBRTlFLElBQUlHO0lBQ0osSUFBS2hCLGlCQUFrQjtRQUNyQmdCLGdCQUFnQixDQUFDLFVBQVUsRUFBRXBCLGNBQWMsV0FBVyxDQUFDLEdBQ3ZDLENBQUMsUUFBUSxFQUFFYixHQUFHa0MsWUFBWSxDQUFFLDJDQUEyQyxTQUFVLFdBQVcsQ0FBQyxHQUM3Rix3WEFDQXBCLFFBQVFxQixHQUFHLENBQUVDLENBQUFBLFNBQVUsR0FBR0osWUFBYUksU0FBVSxFQUFHQyxJQUFJLENBQUUsUUFBUztJQUNyRixPQUNLO1FBQ0hKLGdCQUFnQjtZQUFFcEI7ZUFBa0JDO1NBQVMsQ0FBQ3FCLEdBQUcsQ0FBRUMsQ0FBQUEsU0FBVSxDQUFDLCtCQUErQixFQUFFQSxPQUFPLFNBQVMsQ0FBQyxFQUFHQyxJQUFJLENBQUU7SUFDM0g7SUFFQSxPQUFPbkMsbUJBQW1Cb0MsbUJBQW1CLENBQUVyQyxNQUFNc0MsSUFBSSxDQUFDQyxJQUFJLENBQUUsa0NBQW1DO1FBQ2pHQyxzQkFBc0I7UUFDdEJDLGdCQUFnQmpDLFFBQVFrQyxVQUFVLENBQUV6QjtRQUNwQzBCLGtCQUFrQjVCO1FBRWxCLHNDQUFzQztRQUN0QzZCLGtCQUFrQlo7UUFFbEIsc0RBQXNEO1FBQ3REYSxVQUFVckMsUUFBUWtDLFVBQVUsQ0FBRXpCO1FBQzlCNkIsUUFBUSxHQUFHNUIsWUFBWVIsS0FBSyxDQUFDLEVBQUVJLE9BQU8sS0FBSyxDQUFDO1FBQzVDaUMsVUFBVSxHQUFHN0IsWUFBWVIsS0FBSyxRQUFRLENBQUM7SUFDekM7QUFDRiJ9